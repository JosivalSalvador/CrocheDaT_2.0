name: CI/CD Pipeline

on:
  push:
    branches: [dev]
  pull_request:
    branches: [dev, main]

# Permissﾃ｣o necessﾃ｡ria para abrir o PR automaticamente
permissions:
  contents: write
  pull-requests: write

jobs:
  # ====================================================
  # 1. VERIFICAﾃﾃグ DE QUALIDADE (SERVER)
  # ====================================================
  server-check:
    name: Server (Lint, Types, Tests)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./server
    # Banco na RAM para teste
    services:
      postgres:
        image: postgres:18-alpine
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: ecommerce_test
        ports:
          - 5432:5432
        options: >-
          --mount type=tmpfs,destination=/var/lib/postgresql/data
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: './server/package-lock.json'

      - name: Install Deps
        run: npm ci --prefer-offline --no-audit

      - name: Create .env.test
        run: |
          echo "DATABASE_URL=postgresql://user:password@localhost:5432/ecommerce_test?schema=public" > .env.test
          echo "JWT_SECRET=ci-secret" >> .env.test
          echo "NODE_ENV=test" >> .env.test

      - name: Run Lint
        run: npm run lint

      - name: Run Type Check
        run: npm run type-check

      - name: Run Tests
        run: npm run test

  # ====================================================
  # 2. VERIFICAﾃﾃグ DE QUALIDADE (WEB)
  # ====================================================
  web-check:
    name: Web (Lint, Types, Tests)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./web
    
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: './web/package-lock.json'

      - name: Install Deps
        run: npm ci --prefer-offline --no-audit

      - name: Run Lint
        run: npm run lint

      - name: Run Type Check
        run: npm run type-check

      - name: Run Tests
        run: npm run test:run

  # ====================================================
  # 3. VERIFICAﾃﾃグ DE BUILD DOCKER (PRODUﾃﾃグ)
  # ====================================================
  docker-build-check:
    name: Verify Prod Docker Build
    runs-on: ubuntu-latest
    # Sﾃｳ roda se os testes de Server E Web passarem
    needs: [server-check, web-check]
    
    steps:
      - uses: actions/checkout@v4

      # Criamos arquivos .env falsos apenas para o Docker Compose nﾃ｣o reclamar de arquivo faltando
      # As variﾃ｡veis reais dentro da imagem sﾃ｣o tratadas pelos Dockerfiles (ARG/dummy)
      - name: Create Dummy Envs for Compose
        run: |
          echo "POSTGRES_USER=user" > ./server/.env
          echo "POSTGRES_PASSWORD=pass" >> ./server/.env
          echo "POSTGRES_DB=db" >> ./server/.env
          echo "DATABASE_URL=postgres://dummy" >> ./server/.env
          echo "JWT_SECRET=dummy" >> ./server/.env
          echo "NEXT_PUBLIC_API_URL=http://localhost:3333" > ./web/.env

      - name: Build Production Images
        # Tenta construir as imagens usando o arquivo de produﾃｧﾃ｣o
        run: docker compose -f docker-compose.yml build

  # ====================================================
  # 4. ABRIR PULL REQUEST (DEV -> MAIN)
  # ====================================================
  auto-pr:
    name: Open PR to Main
    runs-on: ubuntu-latest
    needs: [docker-build-check]
    # Sﾃｳ roda se for um push na branch 'dev'
    if: github.ref == 'refs/heads/dev' && github.event_name == 'push'
    
    steps:
      - uses: actions/checkout@v4

      - name: Check for existing PR
        id: check_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Verifica se jﾃ｡ existe PR aberto de dev para main
          count=$(gh pr list --base main --head dev --json id --jq '. | length')
          if [ "$count" -gt 0 ]; then
            echo "PR already exists."
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check_pr.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --base main \
            --head dev \
            --title "噫 Release: Merge dev to main" \
            --body "Automated PR created by CI pipeline after passing all tests and build checks."